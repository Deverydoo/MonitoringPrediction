#!/usr/bin/env python3
"""
API Key Generator and Manager for ArgusAI

Built by Craig Giannelli and Claude Code

This script generates a secure API key and stores it in a dedicated file
(.nordiq_key) separate from other environment variables (.env).

Usage:
    python bin/generate_api_key.py              # Generate new key if none exists
    python bin/generate_api_key.py --force      # Force regenerate even if exists
    python bin/generate_api_key.py --show       # Show current key without regenerating
"""

import os
import sys
import secrets
import string
from pathlib import Path

# Get the NordIQ root directory (parent of bin/)
NORDIQ_ROOT = Path(__file__).parent.parent


def generate_secure_key(length: int = 64) -> str:
    """Generate a cryptographically secure random API key."""
    alphabet = string.ascii_letters + string.digits
    return ''.join(secrets.choice(alphabet) for _ in range(length))


def read_existing_key() -> str:
    """Read existing API key from .nordiq_key if it exists."""
    key_file = NORDIQ_ROOT / '.nordiq_key'
    if key_file.exists():
        try:
            with open(key_file, 'r') as f:
                key = f.read().strip()
                return key
        except Exception as e:
            print(f"[WARNING] Error reading existing key: {e}")
    return ""


def write_nordiq_key(api_key: str):
    """Write API key to .nordiq_key file."""
    key_file = NORDIQ_ROOT / '.nordiq_key'

    with open(key_file, 'w') as f:
        f.write(api_key)

    # Set file permissions to 600 (owner read/write only) on Unix systems
    try:
        os.chmod(key_file, 0o600)
    except Exception:
        pass  # Windows doesn't support chmod

    print(f"[OK] NordIQ API key: .nordiq_key")


def write_env_file(api_key: str):
    """Write API key to .env file for dashboard and keep it synced with .nordiq_key."""
    env_file = NORDIQ_ROOT / '.env'

    # If .env exists, update the TFT_API_KEY line, otherwise create new file
    if env_file.exists():
        with open(env_file, 'r') as f:
            lines = f.readlines()

        # Update existing TFT_API_KEY or add it
        key_found = False
        with open(env_file, 'w') as f:
            for line in lines:
                if line.startswith('TFT_API_KEY='):
                    f.write(f'TFT_API_KEY={api_key}\n')
                    key_found = True
                else:
                    f.write(line)

            # If TFT_API_KEY wasn't in the file, add it
            if not key_found:
                f.write(f'\n# API Key for daemon authentication (synced with .nordiq_key)\n')
                f.write(f'TFT_API_KEY={api_key}\n')
    else:
        # Create new .env file with template
        content = f'''# Environment Variables for ArgusAI Predictive System Monitoring
# Auto-generated by generate_api_key.py

# API Key for daemon authentication (synced with .nordiq_key)
TFT_API_KEY={api_key}

# Daemon Configuration
DAEMON_HOST=0.0.0.0
DAEMON_PORT=8000

# Metrics Generator Configuration
METRICS_GENERATOR_HOST=0.0.0.0
METRICS_GENERATOR_PORT=8001

# Logging
LOG_LEVEL=INFO
'''
        with open(env_file, 'w') as f:
            f.write(content)

    print(f"[OK] Dashboard configuration: .env file (synced with .nordiq_key)")


def ensure_gitignore():
    """Ensure .gitignore protects secret files."""
    gitignore_file = NORDIQ_ROOT / '.gitignore'

    entries_needed = [
        '.nordiq_key',
        '.env'
    ]

    if gitignore_file.exists():
        with open(gitignore_file, 'r') as f:
            existing = f.read()

        needs_update = False
        for entry in entries_needed:
            if entry not in existing:
                needs_update = True
                break

        if needs_update:
            with open(gitignore_file, 'a') as f:
                f.write('\n# API Keys and Secrets\n')
                for entry in entries_needed:
                    if entry not in existing:
                        f.write(f'{entry}\n')
            print(f"[OK] Updated .gitignore to protect secrets")
    else:
        with open(gitignore_file, 'w') as f:
            f.write('# API Keys and Secrets\n')
            for entry in entries_needed:
                f.write(f'{entry}\n')
        print(f"[OK] Created .gitignore to protect secrets")


def main():
    """Main entry point."""
    import argparse

    parser = argparse.ArgumentParser(description='Generate and manage API keys')
    parser.add_argument('--force', action='store_true',
                       help='Force regenerate even if key exists')
    parser.add_argument('--show', action='store_true',
                       help='Show current key without regenerating')
    args = parser.parse_args()

    # Show current key if requested
    if args.show:
        existing_key = read_existing_key()
        if existing_key:
            print(f"Current API Key: {existing_key}")
        else:
            print("No API key found. Run without --show to generate one.")
        return

    # Check if key already exists
    existing_key = read_existing_key()

    if existing_key and not args.force:
        print("API key already configured!")
        print(f"Key: {existing_key[:20]}...{existing_key[-10:]}")
        print()
        print("The API key is stored in:")
        print("  - .nordiq_key (used by daemon)")
        print("  - .env (used by dashboard - MUST BE SYNCED!)")
        print()
        print("To regenerate and re-sync both files, run with --force flag")
        return

    # Generate new key
    if args.force and existing_key:
        print("Regenerating API key (--force flag set)...")
    else:
        print("Generating new API key...")

    api_key = generate_secure_key(64)

    # Write to both locations (IMPORTANT: Keep .nordiq_key and .env in sync!)
    write_nordiq_key(api_key)
    write_env_file(api_key)
    ensure_gitignore()

    print()
    print("=" * 60)
    print("API Key Configuration Complete!")
    print("=" * 60)
    print()
    print(f"Generated API Key: {api_key}")
    print()
    print("The API key has been configured in:")
    print("  [OK] .nordiq_key (used by daemon)")
    print("  [OK] .env (used by dashboard)")
    print()
    print("IMPORTANT: Both files MUST have the same key!")
    print("  - Daemon reads from .nordiq_key")
    print("  - Dashboard reads from .env via environment variable")
    print("  - This script keeps them in sync automatically")
    print()
    print("To start the system:")
    print("  Windows: start_all.bat")
    print("  Linux:   ./start_all.sh")
    print()
    print("Security notes:")
    print("  - Both .nordiq_key and .env are protected by .gitignore")
    print("  - Keep this key secret and secure")
    print("  - Rotate periodically for security")
    print("  - If authentication fails, run: python bin/generate_api_key.py --force")
    print()


if __name__ == '__main__':
    main()
