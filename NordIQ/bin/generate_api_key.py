#!/usr/bin/env python3
"""
API Key Generator and Manager for NordIQ AI Systems

Copyright Â© 2025 NordIQ AI, LLC. All rights reserved.

This script generates a secure API key and configures it for both
the dashboard (.streamlit/secrets.toml) and daemon (environment variable).

Usage:
    python bin/generate_api_key.py              # Generate new key if none exists
    python bin/generate_api_key.py --force      # Force regenerate even if exists
    python bin/generate_api_key.py --show       # Show current key without regenerating
"""

import os
import sys
import secrets
import string
from pathlib import Path

# Get the NordIQ root directory (parent of bin/)
NORDIQ_ROOT = Path(__file__).parent.parent


def generate_secure_key(length: int = 64) -> str:
    """Generate a cryptographically secure random API key."""
    alphabet = string.ascii_letters + string.digits
    return ''.join(secrets.choice(alphabet) for _ in range(length))


def read_existing_key() -> str:
    """Read existing API key from secrets.toml if it exists."""
    secrets_file = NORDIQ_ROOT / '.streamlit/secrets.toml'
    if secrets_file.exists():
        try:
            with open(secrets_file, 'r') as f:
                for line in f:
                    if 'api_key = ' in line:
                        # Extract key from: api_key = "key_here"
                        key = line.split('"')[1]
                        return key
        except Exception as e:
            print(f"[WARNING] Error reading existing key: {e}")
    return ""


def write_secrets_toml(api_key: str):
    """Write API key to .streamlit/secrets.toml."""
    secrets_dir = NORDIQ_ROOT / '.streamlit'
    secrets_dir.mkdir(exist_ok=True)

    secrets_file = secrets_dir / 'secrets.toml'

    content = f'''# Streamlit Secrets Configuration
# This file contains sensitive configuration values
# DO NOT commit this file to version control!

[daemon]
# API key for TFT Inference Daemon authentication
# This key must match the TFT_API_KEY environment variable on the daemon
api_key = "{api_key}"

# Production deployment notes:
# 1. Set this same key in your daemon environment: export TFT_API_KEY="..."
# 2. This file is automatically managed by generate_api_key.py
# 3. The start scripts will automatically set the environment variable
'''

    with open(secrets_file, 'w') as f:
        f.write(content)

    print(f"[OK] Dashboard configuration: .streamlit/secrets.toml")


def write_env_file(api_key: str):
    """Write API key to .env file for daemon."""
    env_file = NORDIQ_ROOT / '.env'

    content = f'''# Environment Variables for TFT Monitoring System
# Auto-generated by generate_api_key.py

# API Key for daemon authentication (matches .streamlit/secrets.toml)
TFT_API_KEY={api_key}

# Daemon Configuration
DAEMON_HOST=0.0.0.0
DAEMON_PORT=8000

# Metrics Generator Configuration
METRICS_GENERATOR_HOST=0.0.0.0
METRICS_GENERATOR_PORT=8001

# Model Configuration
MODEL_DIR=models/tft_model_20251015_080653

# Logging
LOG_LEVEL=INFO
'''

    with open(env_file, 'w') as f:
        f.write(content)

    print(f"[OK] Daemon configuration: .env")


def ensure_gitignore():
    """Ensure .gitignore protects secret files."""
    gitignore_file = Path('.gitignore')

    entries_needed = [
        '.streamlit/secrets.toml',
        '.env'
    ]

    if gitignore_file.exists():
        with open(gitignore_file, 'r') as f:
            existing = f.read()

        needs_update = False
        for entry in entries_needed:
            if entry not in existing:
                needs_update = True
                break

        if needs_update:
            with open(gitignore_file, 'a') as f:
                f.write('\n# API Keys and Secrets\n')
                for entry in entries_needed:
                    if entry not in existing:
                        f.write(f'{entry}\n')
            print(f"[OK] Updated .gitignore to protect secrets")
    else:
        with open(gitignore_file, 'w') as f:
            f.write('# API Keys and Secrets\n')
            for entry in entries_needed:
                f.write(f'{entry}\n')
        print(f"[OK] Created .gitignore to protect secrets")


def main():
    """Main entry point."""
    import argparse

    parser = argparse.ArgumentParser(description='Generate and manage API keys')
    parser.add_argument('--force', action='store_true',
                       help='Force regenerate even if key exists')
    parser.add_argument('--show', action='store_true',
                       help='Show current key without regenerating')
    args = parser.parse_args()

    # Show current key if requested
    if args.show:
        existing_key = read_existing_key()
        if existing_key:
            print(f"Current API Key: {existing_key}")
        else:
            print("No API key found. Run without --show to generate one.")
        return

    # Check if key already exists
    existing_key = read_existing_key()

    if existing_key and not args.force:
        print("API key already configured!")
        print(f"Key: {existing_key[:20]}...{existing_key[-10:]}")
        print()
        print("The API key is already set up in:")
        print("  - .streamlit/secrets.toml (dashboard)")
        print("  - .env (daemon)")
        print()
        print("To regenerate, run with --force flag")
        return

    # Generate new key
    if args.force and existing_key:
        print("Regenerating API key (--force flag set)...")
    else:
        print("Generating new API key...")

    api_key = generate_secure_key(64)

    # Write to both locations
    write_secrets_toml(api_key)
    write_env_file(api_key)
    ensure_gitignore()

    print()
    print("=" * 60)
    print("API Key Configuration Complete!")
    print("=" * 60)
    print()
    print(f"Generated API Key: {api_key}")
    print()
    print("The API key has been configured in:")
    print("  [OK] .streamlit/secrets.toml (dashboard)")
    print("  [OK] .env (daemon environment)")
    print()
    print("Next steps:")
    print("  1. Start the system with start_all.bat (Windows) or start_all.sh (Linux/Mac)")
    print("  2. The scripts will automatically load the API key")
    print()
    print("Security notes:")
    print("  - This key is protected by .gitignore (not committed)")
    print("  - Keep this key secret and secure")
    print("  - Rotate periodically for security")
    print()


if __name__ == '__main__':
    main()
